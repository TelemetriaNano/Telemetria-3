<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCADA NANO v2.0 - Industrial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.4;
        }

        /* ===== LOGIN SCREEN ===== */
        #login-screen {
            position: fixed;
            inset: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-box {
            background: #161b22;
            padding: 50px 40px;
            border-radius: 8px;
            border: 1px solid #30363d;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            text-align: center;
            min-width: 380px;
            max-width: 90%;
        }

        .login-box h1 {
            font-size: 2.4em;
            margin-bottom: 8px;
            color: #58a6ff;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .login-box p {
            color: #8b949e;
            margin-bottom: 30px;
            font-size: 0.95em;
        }

        .login-box input {
            width: 100%;
            padding: 14px;
            font-size: 1.1em;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #0d1117;
            color: #e6edf3;
            margin-bottom: 20px;
            font-family: inherit;
        }

        .login-box input:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
        }

        .login-box button {
            width: 100%;
            padding: 14px;
            font-size: 1.1em;
            border: none;
            border-radius: 6px;
            background: #238636;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .login-box button:hover {
            background: #2ea043;
            box-shadow: 0 4px 12px rgba(46, 160, 67, 0.3);
        }

        .login-error {
            color: #f85149;
            margin-top: 16px;
            font-weight: 500;
            display: none;
        }

        /* ===== MAIN DASHBOARD ===== */
        #dashboard {
            display: none;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 1px solid #30363d;
        }

        .header h1 {
            font-size: 2.3em;
            color: #e6edf3;
            font-weight: 600;
            letter-spacing: 1.5px;
        }

        .header .version {
            color: #8b949e;
            font-size: 0.9em;
            margin-top: 4px;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 24px;
            margin-bottom: 32px;
            padding: 16px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95em;
            color: #c9d1d9;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2.2s infinite;
        }

        .status-indicator.connected    { background: #238636; box-shadow: 0 0 10px #23863680; }
        .status-indicator.connecting   { background: #d29922; box-shadow: 0 0 10px #d2992280; }
        .status-indicator.disconnected { background: #f85149; box-shadow: 0 0 10px #f8514980; }

        @keyframes pulse {
            0%, 100% { opacity: 0.95; }
            50%      { opacity: 0.4;  }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .card {
            background: #161b22;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #30363d;
            transition: all 0.18s ease;
        }

        .card:hover {
            border-color: #58a6ff44;
            box-shadow: 0 0 16px rgba(88, 166, 255, 0.12);
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 0.82em;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: #8b949e;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .card-value {
            font-size: 2.4em;
            font-weight: 600;
            color: #e6edf3;
            margin: 12px 0;
        }

        .card-subtitle {
            font-size: 0.82em;
            color: #8b949e;
        }

        /* ===== CONTROLES ===== */
        .control-card {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .btn {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 14px 28px;
            font-size: 1em;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.18s;
            font-weight: 500;
        }

        .btn:hover {
            border-color: #58a6ff;
            background: #21262d;
            box-shadow: 0 0 12px rgba(88, 166, 255, 0.25);
        }

        .btn.on {
            background: #238636;
            color: white;
            border-color: #238636;
            box-shadow: 0 0 14px rgba(35, 134, 54, 0.4);
        }

        .btn.off {
            background: #21262d;
            color: #8b949e;
            border-color: #30363d;
        }

        .slider-container {
            margin-top: 8px;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #30363d;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #58a6ff;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(88, 166, 255, 0.5);
            border: 2px solid #0d1117;
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #58a6ff;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(88, 166, 255, 0.5);
            border: 2px solid #0d1117;
        }

        .value-display {
            text-align: center;
            font-size: 1.6em;
            font-weight: 600;
            margin-top: 12px;
            color: #58a6ff;
        }

        .alarm-active {
            animation: alarmPulse 1.4s infinite;
            border-color: #f85149 !important;
            box-shadow: 0 0 16px rgba(248, 81, 73, 0.3);
        }

        @keyframes alarmPulse {
            0%, 100% { box-shadow: 0 0 12px rgba(248,81,73,0.25); }
            50%      { box-shadow: 0 0 24px rgba(248,81,73,0.55); }
        }

        /* ===== EVENT LOG ===== */
        .event-log-container {
            grid-column: 1 / -1;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            max-height: 320px;
            overflow-y: auto;
        }

        .event-log-title {
            font-size: 1.1em;
            margin-bottom: 16px;
            color: #58a6ff;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 500;
            border-bottom: 1px solid #30363d;
            padding-bottom: 12px;
        }

        .event-item {
            padding: 10px 14px;
            margin-bottom: 6px;
            background: #161b22;
            border-left: 3px solid #30363d;
            font-size: 0.9em;
            transition: all 0.15s;
        }

        .event-item:hover {
            background: #1f2428;
        }

        .event-item.alarm {
            border-left-color: #f85149;
            color: #f85149;
        }

        .event-item.control {
            border-left-color: #58a6ff;
            color: #79c0ff;
        }

        .event-item.info {
            border-left-color: #388bfd;
            color: #a5d6ff;
        }

        .event-timestamp {
            opacity: 0.6;
            margin-right: 12px;
            font-size: 0.85em;
        }

        /* Scrollbar */
        .event-log-container::-webkit-scrollbar {
            width: 8px;
        }

        .event-log-container::-webkit-scrollbar-track {
            background: #0d1117;
        }

        .event-log-container::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        .event-log-container::-webkit-scrollbar-thumb:hover {
            background: #444d56;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #21262d;
            color: #f85149;
            border: 1px solid #f8514940;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: #f85149;
            color: white;
            border-color: #f85149;
            box-shadow: 0 0 12px rgba(248,81,73,0.4);
        }

        @media (max-width: 768px) {
            .login-box { padding: 40px 25px; min-width: 320px; }
            .header h1 { font-size: 1.9em; }
            .card-value { font-size: 2.1em; }
        }
    </style>
</head>
<body>

    <!-- ===== PANTALLA DE LOGIN ===== -->
    <div id="login-screen">
        <div class="login-box">
            <h1>SCADA NANO</h1>
            <p>SISTEMA DE TELEMETR√çA INDUSTRIAL</p>
            <input type="password" id="password-input" placeholder="INGRESE C√ìDIGO DE ACCESO"
                   onkeypress="if(event.key==='Enter') login()">
            <button onclick="login()">INGRESAR</button>
            <div class="login-error" id="login-error">‚úó ACCESO DENEGADO</div>
        </div>
    </div>

    <!-- ===== DASHBOARD PRINCIPAL ===== -->
    <div id="dashboard">
        <button class="logout-btn" onclick="logout()">SALIR</button>
       
        <div class="header">
            <h1>SCADA NANO CONTROL PANEL</h1>
            <div class="version">SISTEMA INDUSTRIAL v2.0 - OPTIMIZADO</div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator connecting" id="mqtt-indicator"></div>
                <span id="mqtt-status">MQTT: CONECTANDO...</span>
            </div>
            <div class="status-item">
                <span>UPTIME: <strong id="uptime">00:00:00</strong></span>
            </div>
            <div class="status-item">
                <span>RAM: <strong id="memory">0 KB</strong></span>
            </div>
        </div>

        <div class="container">
            <!-- SENSORES ANAL√ìGICOS -->
            <div class="card" id="card-nivel">
                <div class="card-title">NIVEL TANQUE</div>
                <div class="card-value" id="nivel-value">0%</div>
                <div class="card-subtitle">POTENCI√ìMETRO 1</div>
            </div>

            <div class="card">
                <div class="card-title">PRESI√ìN SISTEMA</div>
                <div class="card-value" id="presion-value">0%</div>
                <div class="card-subtitle">POTENCI√ìMETRO 2</div>
            </div>

            <!-- SENSORES DIGITALES -->
            <div class="card">
                <div class="card-title">SENSOR PUERTA</div>
                <div class="card-value" id="puerta-value">CERRADA</div>
                <div class="card-subtitle">SWITCH 1</div>
            </div>

            <div class="card">
                <div class="card-title">SENSOR NIVEL</div>
                <div class="card-value" id="sensor-nivel-value">BAJO</div>
                <div class="card-subtitle">SWITCH 2</div>
            </div>

            <!-- ALARMAS -->
            <div class="card">
                <div class="card-title">ALARMAS</div>
                <div class="card-value" id="alarm-count">0</div>
                <div class="card-subtitle" id="alarm-status">SISTEMA NORMAL</div>
            </div>

            <!-- CONTROL SERVO -->
            <div class="card control-card">
                <div class="card-title">V√ÅLVULA</div>
                <div class="slider-container">
                    <input type="range" min="0" max="180" value="0" class="slider"
                           id="servo-slider">
                    <div class="value-display" id="servo-display">0¬∞</div>
                </div>
            </div>

            <!-- CONTROL BOMBAS -->
            <div class="card control-card">
                <div class="card-title">BOMBA 1</div>
                <button class="btn off" id="bomba1-btn" onclick="toggleBomba1()">
                    <span id="bomba1-text">[ OFF ]</span>
                </button>
            </div>

            <div class="card control-card">
                <div class="card-title">BOMBA 2</div>
                <button class="btn off" id="bomba2-btn" onclick="toggleBomba2()">
                    <span id="bomba2-text">[ OFF ]</span>
                </button>
            </div>

            <!-- EVENT LOG -->
            <div class="event-log-container">
                <div class="event-log-title">REGISTRO DE EVENTOS (√öLTIMOS 10)</div>
                <div id="event-log"></div>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURACI√ìN =====
        const CORRECT_PASSWORD = "Nano01";
        const broker = "wss://430b579b966d4e73a269ce0c803564a7.s1.eu.hivemq.cloud:8884/mqtt";
        const options = {
            clientId: 'Dashboard_' + Math.random().toString(16).substr(2, 8),
            username: 'Telemetria-Nano',
            password: 'Telemetria01',
            clean: true,
            reconnectPeriod: 5000
        };

        // ===== VARIABLES GLOBALES =====
        let client;
        let bomba1State = false;
        let bomba2State = false;
        let servoAngle = 0;
        let startTime = Date.now();
        let eventLog = [];
        const MAX_EVENTS = 10;

        // ===== EVENT LOG =====
        function addEvent(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const event = { timestamp, message, type };
           
            eventLog.unshift(event);
            if (eventLog.length > MAX_EVENTS) {
                eventLog.pop();
            }
           
            updateEventLogDisplay();
        }

        function updateEventLogDisplay() {
            const container = document.getElementById('event-log');
            container.innerHTML = eventLog.map(event => `
                <div class="event-item ${event.type}">
                    <span class="event-timestamp">[${event.timestamp}]</span>
                    ${event.message}
                </div>
            `).join('');
        }

        // ===== LOGIN =====
        function login() {
            const password = document.getElementById('password-input').value;
           
            if (password === CORRECT_PASSWORD) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                connectMQTT();
                addEvent('Dashboard iniciado correctamente', 'info');
            } else {
                document.getElementById('login-error').style.display = 'block';
                document.getElementById('password-input').value = '';
                document.getElementById('password-input').focus();
               
                setTimeout(() => {
                    document.getElementById('login-error').style.display = 'none';
                }, 3000);
            }
        }

        function logout() {
            if (confirm('¬øConfirmar cierre de sesi√≥n?')) {
                if (client) client.end();
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('password-input').value = '';
            }
        }

        // ===== FUNCIONES DE UTILIDAD =====
        function updateIndicator(id, status) {
            const indicator = document.getElementById(id);
            indicator.className = 'status-indicator ' + status;
        }

        function updateBomba1UI(state) {
            bomba1State = state;
            const btn = document.getElementById('bomba1-btn');
            const text = document.getElementById('bomba1-text');
           
            if (state) {
                btn.className = 'btn on';
                text.textContent = '[ ON ]';
            } else {
                btn.className = 'btn off';
                text.textContent = '[ OFF ]';
            }
        }

        function updateBomba2UI(state) {
            bomba2State = state;
            const btn = document.getElementById('bomba2-btn');
            const text = document.getElementById('bomba2-text');
           
            if (state) {
                btn.className = 'btn on';
                text.textContent = '[ ON ]';
            } else {
                btn.className = 'btn off';
                text.textContent = '[ OFF ]';
            }
        }

        function updateServoUI(angle) {
            servoAngle = angle;
            document.getElementById('servo-slider').value = angle;
            document.getElementById('servo-display').textContent = angle + '¬∞';
        }

        // ===== CONTROLES (CON PUBLICACI√ìN) =====
        function toggleBomba1() {
            bomba1State = !bomba1State;
            client.publish('esp32/control/bomba1', bomba1State ? '1' : '0');
            updateBomba1UI(bomba1State);
            addEvent(`Bomba 1 ${bomba1State ? 'ENCENDIDA' : 'APAGADA'}`, 'control');
        }

        function toggleBomba2() {
            bomba2State = !bomba2State;
            client.publish('esp32/control/bomba2', bomba2State ? '1' : '0');
            updateBomba2UI(bomba2State);
            addEvent(`Bomba 2 ${bomba2State ? 'ENCENDIDA' : 'APAGADA'}`, 'control');
        }

        // ===== SLIDER =====
        const slider = document.getElementById('servo-slider');
       
        slider.addEventListener('input', (e) => {
            document.getElementById('servo-display').textContent = e.target.value + '¬∞';
        });
       
        slider.addEventListener('change', (e) => {
            const angle = e.target.value;
            servoAngle = angle;
            client.publish('esp32/control/valvula', angle.toString());
            addEvent(`V√°lvula ajustada a ${angle}¬∞`, 'control');
        });

        // ===== MQTT =====
        function connectMQTT() {
            client = mqtt.connect(broker, options);

            client.on('connect', () => {
                updateIndicator('mqtt-indicator', 'connected');
                document.getElementById('mqtt-status').textContent = 'MQTT: CONECTADO';
                addEvent('Conectado a broker MQTT', 'info');
               
                client.subscribe('esp32/sensores/#');
                client.subscribe('esp32/alarmas/#');
                client.subscribe('esp32/system/#');
                client.subscribe('esp32/estado/bomba1');
                client.subscribe('esp32/estado/bomba2');
                client.subscribe('esp32/estado/valvula');
               
                setTimeout(() => {
                    client.publish('esp32/control/request_state', '1');
                }, 500);
            });

            client.on('message', (topic, message) => {
                const msg = message.toString();
               
                switch(topic) {
                    case 'esp32/sensores/nivel':
                        const nivel = parseInt(msg);
                        document.getElementById('nivel-value').textContent = nivel + '%';
                        break;
                       
                    case 'esp32/sensores/presion':
                        const presion = parseInt(msg);
                        document.getElementById('presion-value').textContent = presion + '%';
                        break;
                       
                    case 'esp32/sensores/puerta':
                        const puerta = msg === '1';
                        const puertaEl = document.getElementById('puerta-value');
                        puertaEl.textContent = puerta ? 'ABIERTA' : 'CERRADA';
                        puertaEl.style.color = puerta ? '#f85149' : '#58a6ff';
                        if (puerta) addEvent('‚ö† Puerta ABIERTA detectada', 'alarm');
                        break;
                       
                    case 'esp32/sensores/sensor_nivel':
                        const sensorNivel = msg === '1';
                        const sensorEl = document.getElementById('sensor-nivel-value');
                        sensorEl.textContent = sensorNivel ? 'ALTO' : 'BAJO';
                        sensorEl.style.color = sensorNivel ? '#58a6ff' : '#d29922';
                        break;
                       
                    case 'esp32/alarmas/estado':
                        const alarmActive = msg === '1';
                        const card = document.getElementById('card-nivel');
                        const statusText = document.getElementById('alarm-status');
                       
                        if (alarmActive) {
                            card.classList.add('alarm-active');
                            statusText.textContent = '‚ö† ALARMA ACTIVA';
                            statusText.style.color = '#f85149';
                            addEvent('üö® ALARMA ACTIVADA - Nivel cr√≠tico', 'alarm');
                        } else {
                            card.classList.remove('alarm-active');
                            statusText.textContent = 'SISTEMA NORMAL';
                            statusText.style.color = '#c9d1d9';
                        }
                        break;
                       
                    case 'esp32/alarmas/conteo':
                        document.getElementById('alarm-count').textContent = msg;
                        break;
                       
                    case 'esp32/system/memory':
                        const memKB = Math.round(parseInt(msg) / 1024);
                        document.getElementById('memory').textContent = memKB + ' KB';
                        break;
                   
                    case 'esp32/estado/bomba1':
                        updateBomba1UI(msg === '1');
                        break;
                       
                    case 'esp32/estado/bomba2':
                        updateBomba2UI(msg === '1');
                        break;
                       
                    case 'esp32/estado/valvula':
                        updateServoUI(parseInt(msg));
                        break;
                }
            });

            client.on('error', (err) => {
                updateIndicator('mqtt-indicator', 'disconnected');
                document.getElementById('mqtt-status').textContent = 'MQTT: ERROR';
                addEvent('Error de conexi√≥n MQTT', 'alarm');
            });

            client.on('reconnect', () => {
                updateIndicator('mqtt-indicator', 'connecting');
                document.getElementById('mqtt-status').textContent = 'MQTT: RECONECTANDO';
            });
        }

        // ===== UPTIME =====
        setInterval(() => {
            const uptime = Math.floor((Date.now() - startTime) / 1000);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = uptime % 60;
           
            const pad = (n) => String(n).padStart(2, '0');
            document.getElementById('uptime').textContent = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        }, 1000);

        window.onload = () => {
            document.getElementById('password-input').focus();
        };
    </script>
</body>
</html>